###setup KDC for REALM
--> see kdcSetup doc


###Setup smartconnect for isilon
-isilon.vlab.local
test ssip & sc


###Kerberize Isilon

isi auth krb5 realm create --realm=VLABKDC.LOCAL --kdc=KDC.vlab.local --admin-server=KDC.vlab.local --default-domain=vlab.local 
isi auth krb5 realm list -v


isi auth krb5 domain create --realm=VLABKDC.LOCAL --domain=vlab.local
isi auth krb5 domain create --realm=VLABKDC.LOCAL --domain=.vlab.local
isi auth krb5 domain list

isi auth krb5 create --realm=VLABKDC.LOCAL --user=isilon/admin@VLABKDC.LOCAL
isi auth krb5 list

isi auth status
isi zones zones modify System --add-auth-provider=lsa-krb5-provider:VLABKDC.LOCAL
isi zones zones list -v

isi auth krb5 spn list
isi auth krb5 spn fix --provider-name=VLABKDC.LOCAL --user=isilon/admin@VLABKDC.LOCAL
isi auth krb5 spn list

###
-add to zone


###create SPN's
isilon/admin@VLABKDC.LOCAL
Password123!


-fix reverse dns
test with nslookup on name/IP

-fix spns if needed
isilon/admin@VLABKDC.LOCAL
Password123!

###
check x permissions on the mount



###setup client for nfsv4 & kerberize

yum install rpcbind nfs-utils nfs4-acl-tools -y

vi /etc/idmapd.conf
[General]
Domain = vlab.local


sttic mappings??




###Modify krb5.conf   - Realm = VLABKDC.LOCAL, DNS = vlab.local
vi /etc/krb5.conf


[logging]
 default = FILE:/var/log/krb5libs.log
 kdc = FILE:/var/log/krb5kdc.log
 admin_server = FILE:/var/log/kadmind.log

[libdefaults]
 default_realm = VLABKDC.LOCAL
 dns_lookup_realm = false
 dns_lookup_kdc = false
 ticket_lifetime = 24h
 renew_lifetime = 7d
 forwardable = true

[realms]
 VLABKDC.LOCAL = {
  kdc = KDC.vlab.local
  admin_server = KDC.vlab.local
  default_domain = vlab.local
 }

[domain_realm]
  .vlab.local = VLABKDC.LOCAL
  vlab.local = VLABKDC.LOCAL





###On Isilon
isi nfs settings global view
isi nfs settings global modify --nfsv4-enabled=true

isi nfs settings zone view
isi nfs settings zone modify --nfsv4-domain=vlab.local


isi nfs exports delete --id=1
mkdir /ifs/mp
mkdir /ifs/mp/nfsv4
chmod -R 777 /ifs/mp/nfsv4
isi nfs exports create --path=/ifs/mm/nfsv4 --map-root=root
isi nfs exports list -view




###On Client - test nfs mount
service rpcbind start; chkconfig rpcbind on
service rpcidmapd start; chkconfig rpcidmapd on
chkconfig netfs on

show mount -e isilon.vlab.local

mkdir /mnt/nfsv4
mount -t nfs4 isilon.vlab.local:/ifs/mp/nfsv4 /mnt/nfsv4
mountstats

cd /mnt/nfsv4
touch 1.txt
ls -al

nfs4_getfacl 1.txt
nfs4_setfacl



su - kdcuser1
touch 2.txt
ls -al
nfs4_getfacl

ls -al  on isilon
ls -le 	on isilon





###Kerberos setup for client nfs
###on KDC
kadmin.local
listprincs
apprinc -randkey nfs/KDC.vlab.local
apprinc -randkey host/KDC.vlab.local

ktadd -k /root/nfs-krb5.keytab nfs/KDC.vlab.local
ktadd -k /root/host-krb5.keytab host/KDC.vlab.local


ktutil
ktutil:  list

ktutil:  rkt /root/nfs-krb5.keytab
ktutil:  rkt /root/host-krb5.keytab
ktutil:  list

ktutil:  wkt /etc/krb5.keytab
ktutil:  exit

ktutil
ktutil: rkt /etc/krb5.keytab
ktutil:  list




######On Host
vi /etc/sysconfig/nfs

SECURE_NFS="yes"


service nfs restart
service rpcidmapd restart
service rpcgssd restart
service rpcbind restart


modprobe rpcsec_gss_krb5

klist 

klist -ke /etc/krb5.keytab

rpc.gssd -f -vvv


###setup isilon export for kerberos access only


###secure mount to isilon
mount –t nfs4 –o sec=krb5 isilon.vlab.local:/ifs/data/mixed /mnt/nfsv4

mountstats

cd /mnt/nfsv4




su - kdcuser1
klist
kinit
klist
cd /mnt/nfsv4

