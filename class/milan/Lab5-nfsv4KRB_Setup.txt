###Setup and configure Kerberos nfsv4 to Isilon



###complete the following, should have been done in other labs
Need to build a KDC
https://github.com/brittup/how_to/blob/master/class/milan/Lab2a-kdcSetup.txt

Kerberize Isilon
https://github.com/brittup/how_to/blob/master/class/milan/Lab2b-isilonKRB_Setup.txt

Get nfsV4 working
https://github.com/brittup/how_to/blob/master/class/milan/Lab4-nfsv4_Setup.txt


#########################################




###Setup kerberos on client if not done - on hdfs1

yum -y install krb5-workstation krb5-libs openldap-clients

###Modify krb5.conf   - Realm = VLABKDC.LOCAL, DNS = demo.local
vi /etc/krb5.conf


[logging]
 default = FILE:/var/log/krb5libs.log
 kdc = FILE:/var/log/krb5kdc.log
 admin_server = FILE:/var/log/kadmind.log

[libdefaults]
 default_realm = VLABKDC.LOCAL
 dns_lookup_realm = false
 dns_lookup_kdc = false
 ticket_lifetime = 24h
 renew_lifetime = 7d
 forwardable = true

[realms]
 VLABKDC.LOCAL = {
  kdc = ldap-kdc.demo.local
  admin_server = ldap-kdc.demo.local
  default_domain = demo.local
 }

[domain_realm]
  .demo.local = VLABKDC.LOCAL
  demo.local = VLABKDC.LOCAL

 
 
###add user if needed to local machine, likely added in prior lab or if tested on KDC host initially
useradd -u 50000 -d /home/kduser1 -m kdcuser1
su - kdcuser1
id
  
###Test Kerberos for user principal created during kdc setup
kinit kdcuser1@VLABKDC.LOCAL
Password123!

klist -e



#########################################
###Setup KRB NFS on Isilon, setup for krb5, krb5i, krb5p
### in this example we use the simplest setup with no ID mgmt to validate krb based mounting
###Setup new export for krb authentication
isi nfs exports list --zone=nfs4


mkdir /ifs/nfs4/krb
chmod -R 777 /ifs/nfs4/krb
isi nfs exports create --zone=nfs4 --path=/ifs/nfs4/krb --map-root=root --security-flavors=krb5,krb5i,krb5p --description=nfsv4krb
isi nfs exports list --zone=nfs4
isi nfs exports view --id=4 --zone=nfs4




###Manual Kerberized nfs setup - create client SPN & keytab on KDC Server, assumes we are using hdfs.demo.local as the nfskrb client 
###
###on KDC host ldap-kdc.demo.local
kadmin.local
listprincs

###add SPNs
addprinc -randkey nfs/<hostname>.demo.local
addprinc -randkey host/<hostname>.demo.local

eg: 
addprinc -randkey nfs/hdfs1.demo.local
addprinc -randkey host/hdfs1.demo.local
listprincs


###create keytab for SPNs
ktadd -k /root/nfs-krb5.keytab nfs/<hostname>.demo.local
ktadd -k /root/host-krb5.keytab host/<hostname>.demo.local

eg:
ktadd -k /root/nfs-krb5.keytab nfs/hdfs1.demo.local
ktadd -k /root/host-krb5.keytab host/hdfs1.demo.local

exit

###review keytab file are created
ls -al /root



##copy keytabs to nfs host, something like...
scp /root/*.keytab root@X.X.X.Y:/root/


###import the keytabs on the host
###ssh to the hostname, review keytabs copied over 
cd /root
ls -al   


ktutil
ktutil:  list

ktutil:  rkt /root/nfs-krb5.keytab
ktutil:  rkt /root/host-krb5.keytab
ktutil:  list
ktutil:  wkt /etc/krb5.keytab
ktutil:  exit

ktutil
ktutil: rkt /etc/krb5.keytab
ktutil: list
exit



######On Host centos7
###secure mount to isilon centos7

systemctl enable nfs-secure
systemctl start nfs-secure
systemctl status nfs-secure

mkdir /mnt/nfsv4krb
mount –t nfs4 –o sec=krb5 <smartconnectname>:/ifs/mp/nfsv4krb /mnt/nfsv4krb



###view SPN used for mount
klist -e
Ticket cache: KEYRING:persistent:0:0
Default principal: nfs/rduvnode258421.west.isilon.com@VLABKDC.LOCAL

Valid starting       Expires              Service principal
01/01/1970 00:00:00  01/01/1970 00:00:00  Encrypted/Credentials/v1@X-GSSPROXY:


###check the status of the mount
mount
mountstats

cd /mnt/nfsv4krb
touch test1.txt
ls -al 


###switch user context
su - kdcuser1
klist
kinit
klist
cd /mnt/nfsv4krb
touch a.txt
ls -al 










###################################
old content
###################################
###mount info
root@rduvnode258421:~ # mountstats
Stats for cdh6-isilon.west.isilon.com:/ifs/zone1/cdh/hadoop-root/mp/nfsv4 mounted on /mnt/nfsv4:
  NFS mount options: rw,vers=4.0,rsize=1048576,wsize=1048576,namlen=255,acregmin=3,acregmax=60,acdirmin=30,acdirmax=60,hard,proto=tcp,port=0,timeo=600,retrans=2,sec=krb5,clientaddr=10.224.37.178,local_lock=none
  NFS server capabilities: caps=0x7fdf,wtmult=512,dtsize=32768,bsize=0,namlen=255
  NFSv4 capability flags: bm0=0xfcffbf7f,bm1=0xf9be3e,bm2=0x0,acl=0x7,pnfs=notconfigured
  NFS security flavor: 6  pseudoflavor: 390003

NFS byte counts:
  applications read 0 bytes via read(2)
  applications wrote 0 bytes via write(2)
  applications read 0 bytes via O_DIRECT read(2)
  applications wrote 0 bytes via O_DIRECT write(2)
  client read 0 bytes via NFS READ
  client wrote 0 bytes via NFS WRITE

RPC statistics:
  39 RPC requests sent, 39 RPC replies received (0 XIDs not found)
  average backlog queue length: 0

SERVER_CAPS:
        2 ops (5%)
        avg bytes sent per op: 184      avg bytes received per op: 120
        backlog wait: 0.000000  RTT: 0.000000   total execute time: 0.000000 (milliseconds)
FSINFO:
        1 ops (2%)
        avg bytes sent per op: 188      avg bytes received per op: 136
        backlog wait: 0.000000  RTT: 0.000000   total execute time: 0.000000 (milliseconds)
GETATTR:
        1 ops (2%)
        avg bytes sent per op: 188      avg bytes received per op: 260
        backlog wait: 0.000000  RTT: 0.000000   total execute time: 0.000000 (milliseconds)
PATHCONF:
        1 ops (2%)
        avg bytes sent per op: 184      avg bytes received per op: 100
        backlog wait: 0.000000  RTT: 0.000000   total execute time: 0.000000 (milliseconds)


		
		
		
		
###secure mount to isilon, centos 6
vi /etc/sysconfig/nfs

SECURE_NFS="yes"

service nfs restart
service rpcidmapd restart
service rpcgssd restart
service rpcbind restart


modprobe rpcsec_gss_krb5

klist -e

klist -ke /etc/krb5.keytab

rpc.gssd -f -vvv
rpc.gssd -f -vvv
mount –t nfs4 –o sec=krb5 <smartconnectname>:/ifs/data/mixed /mnt/nfsv4
mount
mountstats

cd /mnt/nfsv4


su - kdcuser1
klist
kinit
klist
cd /mnt/nfsv4

