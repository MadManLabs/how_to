###this doc is how to install a basic openldap server from scratch

yum update



yum install openldap compat-openldap openldap-clients openldap-servers openldap-servers-sql openldap-devel ntp


systemctl disable firewalld
systemctl stop firewalld
systemctl status firewalld
systemctl enable ntpd
systemctl start ntpd
systemctl status ntpd



###centos7 install


systemctl start slapd.service
systemctl enable slapd.service

slappasswd    
New password : password
Re-enter new password : password
{SSHA}wuaeGiXKrzOUfLYqPzfkQevhbOTwUKYS   < -- copy this


vi db.ldif

dn: olcDatabase={2}hdb,cn=config
changetype: modify
replace: olcSuffix
olcSuffix: dc=demo,dc=local
 
dn: olcDatabase={2}hdb,cn=config
changetype: modify
replace: olcRootDN
olcRootDN: cn=ldapadm,dc=demo,dc=local
 
dn: olcDatabase={2}hdb,cn=config
changetype: modify
replace: olcRootPW
olcRootPW: hashed_output_from_the_slappasswd_command   < -- what you copied earlier


ldapmodify -Y EXTERNAL -H ldapi:/// -f db.ldif




vi monitor.ldif

dn: olcDatabase={1}monitor,cn=config
changetype: modify
replace: olcAccess
olcAccess: {0}to * by dn.base="gidNumber=0+uidNumber=0,cn=peercred,cn=external, cn=auth" read by dn.base="cn=ldapadm,dc=demo,dc=local" read by * none


ldapmodify -Y EXTERNAL -H ldapi:/// -f monitor.ldif




openssl req -new -x509 -nodes -out /etc/openldap/certs/myldap.demo.local.cert -keyout /etc/openldap/certs/myldap.demo.local.key -days 365

chown -R ldap:ldap /etc/openldap/certs



vi certs.ldif

dn: cn=config
changetype: modify
replace: olcTLSCertificateFile
olcTLSCertificateFile: /etc/openldap/certs/myldap.demo.local.cert

dn: cn=config
changetype: modify
replace: olcTLSCertificateKeyFile
olcTLSCertificateKeyFile: /etc/openldap/certs/myldap.demo.local.key


ldapmodify -Y EXTERNAL -H ldapi:/// -f certs.ldif


###test the configuration using the following command:
slaptest -u



Add the LDAP schemas:

# ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/openldap/schema/cosine.ldif
# ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/openldap/schema/nis.ldif
# ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/openldap/schema/inetorgperson.ldif




vi base.ldif

dn: dc=field,dc=linuxhostsupport,dc=com
dc: field
objectClass: top
objectClass: domain

dn: cn=ldapadm,dc=field,dc=linuxhostsupport,dc=com
objectClass: organizationalRole
cn: ldapadm
description: LDAP Manager

dn: ou=People,dc=field,dc=linuxhostsupport,dc=com
objectClass: organizationalUnit
ou: People

dn: ou=Group,dc=field,dc=linuxhostsupport,dc=com
objectClass: organizationalUnit
ou: Group


ldapadd -x -W -D "cn=ldapadm,dc=field,dc=linuxhostsupport,dc=com" -f base.ldif





###get LDAP browser
https://www.ldapadministrator.com/download.htm

###browser setup
192.168.1.20
cn=ldapadm,dc=demo,dc=local

###test ldap search
ldapsearch -x -LLL -b dc=demo,dc=local













###################################################################################################################
###centos6 install
[root]# slappasswd
New password : password
Re-enter new password : password
{SSHA}wuaeGiXKrzOUfLYqPzfkQevhbOTwUKYS   < -- copy this



cd /etc/openldap/slapd.d/cn\=config
ls -al


###update bdb.ldif with a valid password & ldap domain info
vi olcDatabase\=\{2\}bdb.ldif


olcRootPW: {SSHA}wuaeGiXKrzOUfLYqPzfkQevhbOTwUKYS   < -- use copied value here

olcSuffix: dc=demo,dc=local

olcRootDN: cn=Manager,dc=demo,dc=local



###replace the existing  olcAccess: {0}to * ...... entire line with this one

vi olcDatabase\=\{1\}monitor.ldif
olcAccess: {0}to *  by dn.base="gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth" read  by dn.base="cn=Manager,dc=demo,dc=local" read  by * none


###add the following olcAccess: {0} & {1} lines 

vi olcDatabase\=\{2\}bdb.ldif
olcAccess: {0}to attrs=userPassword by self write by dn.base="cn=Manager,dc=demo,dc=local" write by anonymous auth by * none
olcAccess: {1}to * by dn.base="cn=Manager,dc=demo,dc=local" write by self write by * read


###setup services
###centos6
chkconfig iptables off
chkconfig ip6tables off
chkconfig slapd on
chkconfig
service iptables  status
service slapd start


###create Root

cd /tmp
vi demo.ldif

dn: dc=demo,dc=local
objectClass: dcObject
objectClass: organization
dc: demo
o : demo



ldapadd -f demo.ldif -D cn=Manager,dc=demo,dc=local -w password


###get LDAP browser
https://www.ldapadministrator.com/download.htm

###browser setup
192.168.1.20
cn=Manager,dc=demo,dc=local

###test ldap search
ldapsearch -x -LLL -b dc=demo,dc=local



###create user OU
vi users.ldif

dn: ou=users,dc=demo,dc=local
objectClass: organizationalUnit
ou: users

ldapadd -f users.ldif -D cn=Manager,dc=demo,dc=local -w password


###create groups OU
vi groups.ldif

dn: ou=groups,dc=demo,dc=local
objectClass: organizationalUnit
ou: groups

ldapadd -f groups.ldif -D cn=Manager,dc=demo,dc=local -w password


*********************************************************************************************
vi bob.ldif

dn: cn=Bob Jones,ou=Users,dc=demo,dc=local
cn: Bob Jones
sn: Jones
objectClass: inetOrgPerson
userPassword: password
uid: 10000

ldapadd -f bob.ldif -D cn=Manager,dc=demo,dc=local -w password


vi engineering.ldif

dn: cn=Engineering,ou=Users,dc=demo,dc=local
cn: Engineering
objectClass: groupOfNames
member: cn=Bob Jones,ou=Users,dc=demo,dc=local

ldapadd -f engineering.ldif -D cn=Manager,dc=demo,dc=local -w password



vi jack.ldif

dn: cn=Jack Smith,ou=Users,dc=demo,dc=local
cn: Jack Smith
sn: Smith
objectClass: inetOrgPerson
userPassword: password
uid: 10001

ldapadd -f jack.ldif -D cn=Manager,dc=demo,dc=local -w password


vi addUserToGroup.ldif

dn: cn=Engineering,ou=Users,dc=demo,dc=local
changetype: modify
add: member
member: cn=Jack Smith,ou=Users,dc=demo,dc=local

ldapadd -f addUserToGroup.ldif -D cn=Manager,dc=demo,dc=local -w password
